# ---------------------------------------------------
# Ã‰tape 1 : Ã‰tape de test avec toutes les dÃ©pendances
# ---------------------------------------------------
FROM node:18-alpine AS test

WORKDIR /app

# Copier tous les fichiers sources de lâ€™application
COPY . .

# Installer toutes les dÃ©pendances (prod + dev)
RUN yarn install --frozen-lockfile

# Fichier .env spÃ©cifique pour les tests (SQLite par dÃ©faut ici)
COPY .env.test .env

# Argument pour choisir quels tests exÃ©cuter
ARG TEST_SCOPE=all
ENV NODE_ENV=test
ENV LOG_LEVEL=debug
# ExÃ©cution conditionnelle des tests
ARG TEST_RUN_TAG=none  # ğŸ‘ˆ ceci sert Ã  invalider le cache
# Afficher les tests disponibles
RUN yarn test:unit:build --listTests --silent=false --colors --detectOpenHandles

# ExÃ©cuter les bons tests en fonction de TEST_SCOPE
RUN echo "ğŸ§ª Test run tag: $TEST_RUN_TAG" && \
    if [ "$TEST_SCOPE" = "integration" ]; then \
      echo "ğŸ” IntÃ©gration uniquement (SQLite)" && \
      yarn test:integration:test --verbose --silent=false --colors --detectOpenHandles ; \
    elif [ "$TEST_SCOPE" = "fail" ]; then \
      echo "ğŸ’¥ Test KO volontaire" && \
      yarn test:unit:fail --verbose --silent=false --colors --detectOpenHandles  ; \
    else \
      echo "âœ… Unitaires + IntÃ©gration SQLite" && \
      yarn test:unit:build --verbose --silent=false --colors --detectOpenHandles && \
      yarn test:integration:test --verbose --silent=false --colors --detectOpenHandles; \
    fi


